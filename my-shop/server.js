require('dotenv').config();
const express = require('express');
const path = require('path');
const axios = require('axios');
const xml2js = require('xml2js');
const cron = require('node-cron');
const fs = require('fs').promises;
const { existsSync } = require('fs');

const app = express();
const PORT = process.env.PORT || 3000;
const XML_URL = process.env.XML_URL;

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ URL
if (!XML_URL || !XML_URL.startsWith('http')) {
    console.error('–ü–æ–º–∏–ª–∫–∞: –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π URL –¥–ª—è XML. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ .env —Ñ–∞–π–ª');
    process.exit(1);
}

// Middleware
app.use(express.static(path.join(__dirname, 'public')));
app.use(express.json());

// –ö–µ—à –¥–∞–Ω–∏—Ö
let cachedProducts = [];
let cachedCategories = [];
let cachedSubCategories = {};
let lastUpdate = null;

// –û–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö XML
function processData(result) {
    try {
        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞–ø–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –∑ XML
        const categoriesMap = {};
        result.yml_catalog.shop[0].categories[0].category.forEach(cat => {
            categoriesMap[cat.$.id] = cat._;
        });

        // –û—Å–Ω–æ–≤–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ç–∞ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
        const mainCategories = {
            '–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞': [
                '–ù–æ—É—Ç–±—É–∫–∏', '–ü–ª–∞–Ω—à–µ—Ç–Ω—ñ –∫–æ–º–ø\'—é—Ç–µ—Ä–∏', '–ú–æ–±—ñ–ª—å–Ω—ñ —Ç–µ–ª–µ—Ñ–æ–Ω–∏ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∏',
                '–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∫–Ω–∏–≥–∏ (–ü—Ä–∏—Å—Ç—Ä–æ—ó)', '–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏', '–í—ñ–¥–µ–æ–∫–∞–º–µ—Ä–∏, –µ–∫—à–Ω-–∫–∞–º–µ—Ä–∏',
                '–°—É–º–∫–∏ —ñ —Ä—é–∫–∑–∞–∫–∏ –¥–ª—è –Ω–æ—É—Ç–±—É–∫—ñ–≤', '–ß–æ—Ö–ª–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤, –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏—Ö –∫–Ω–∏–≥',
                '–ë–ª–æ–∫–∏ –∂–∏–≤–ª–µ–Ω–Ω—è –¥–æ –∫–æ–º–ø\'—é—Ç–µ—Ä—ñ–≤', '–ü—ñ–¥—Å—Ç–∞–≤–∫–∏ –¥–ª—è –Ω–æ—É—Ç–±—É–∫—ñ–≤',
                '–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ñ –∑–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó', '–ü–∞–≤–µ—Ä–±–∞–Ω–∫–∏', '–ö–∞—Ä—Ç–∏ –ø–∞–º\'—è—Ç—ñ',
                'USB –Ω–∞–∫–æ–ø–∏—á—É–≤–∞—á—ñ', '–ó–∞—Ö–∏—Å–Ω—ñ –ø–ª—ñ–≤–∫–∏ —Ç–∞ —Å–∫–ª–æ –¥–ª—è –ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤',
                '–ß–æ—Ö–ª–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤', 'USB —Ö–∞–±–∏', 'Bluetooth-–∞–¥–∞–ø—Ç–µ—Ä—ñ', '–ë–∞—Ç–∞—Ä–µ–π–∫–∏',
                '–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è', '–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó –¥–ª—è –∞–∫—É–º—É–ª—è—Ç–æ—Ä—ñ–≤',
                '–ù–∞–∫–ª–µ–π–∫–∏ –Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É', '–î–æ—Ä–æ–∂–Ω—ñ —Å—É–º–∫–∏ —Ç–∞ –≤–∞–ª—ñ–∑–∏'
            ],
            '–ö–æ–º–ø\'—é—Ç–µ—Ä–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞': [
                '–°–∏—Å—Ç–µ–º–Ω—ñ –±–ª–æ–∫–∏', '–ú–æ–Ω—ñ—Ç–æ—Ä–∏', '–í–µ–± –∫–∞–º–µ—Ä–∏', '–ü—Ä–∏–Ω—Ç–µ—Ä–∏, —Å–∫–∞–Ω–µ—Ä—ñ, –±—Ñ–ø',
                '–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏', '–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏', '–ù–∞–≤—É—à–Ω–∏–∫–∏ —ñ –≥–∞—Ä–Ω—ñ—Ç—É—Ä–∏',
                '–î–∂–µ—Ä–µ–ª–∞ –±–µ–∑–ø–µ—Ä–µ–±—ñ–π–Ω–æ–≥–æ –∂–∏–≤–ª–µ–Ω–Ω—è', '–°—Ç–∞–±—ñ–ª—ñ–∑–∞—Ç–æ—Ä–∏ –Ω–∞–ø—Ä—É–≥–∏',
                '–ö–æ–º–ø\'—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ —ñ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏', '–î–∂–æ–π—Å—Ç—ñ–∫–∏ —Ç–∞ —ñ–≥—Ä–æ–≤—ñ –º–∞–Ω—ñ–ø—É–ª—è—Ç–æ—Ä–∏',
                '–ö–∏–ª–∏–º–∫–∏ –¥–ª—è –º–∏—à—ñ', '–ó–æ–≤–Ω—ñ—à–Ω—ñ –∂–æ—Ä—Å—Ç–∫—ñ –¥–∏—Å–∫–∏, HDD, SSD',
                '–û–ø—Ç–∏—á–Ω—ñ –ø—Ä–∏–≤–æ–¥–∏', '–ö–∞—Ä–¥—Ä—ñ–¥–µ—Ä–∏', 'DVD, BD —ñ CD –¥–∏—Å–∫–∏',
                '–ü—Ä–æ–≥—Ä–∞–º–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è', '–û—Ñ—ñ—Å–Ω–µ –ü–ó', '–û–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ —É—Ç–∏–ª—ñ—Ç–∏'
            ],
            '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –ü–ö': [
                '–ö–æ—Ä–ø—É—Å–∏ –¥–æ –∫–æ–º–ø\'—é—Ç–µ—Ä—ñ–≤', '–ü—Ä–æ—Ü–µ—Å–æ—Ä–∏', '–í—ñ–¥–µ–æ–∫–∞—Ä—Ç–∏', '–ú–∞—Ç–µ—Ä–∏–Ω—Å—å–∫—ñ –ø–ª–∞—Ç–∏',
                '–ú–æ–¥—É–ª—ñ –ø–∞–º\'—è—Ç—ñ', 'SSD –¥–∏—Å–∫–∏', '–ñ–æ—Ä—Å—Ç–∫—ñ –¥–∏—Å–∫–∏', '–ë–ª–æ–∫–∏ –∂–∏–≤–ª–µ–Ω–Ω—è –¥–æ –∫–æ–º–ø\'—é—Ç–µ—Ä—ñ–≤',
                '–ó–≤—É–∫–æ–≤—ñ –∫–∞—Ä—Ç–∏', '–ú–µ—Ä–µ–∂–µ–≤—ñ –∫–∞—Ä—Ç–∏', 'Wi-fi –∞–¥–∞–ø—Ç–µ—Ä–∏', '–ö—É–ª–µ—Ä–∞ —ñ —Å–∏—Å—Ç–µ–º–∏ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è',
                '–¢–µ—Ä–º–æ–ø—Ä–æ–∫–ª–∞–¥–∫–∏ –π —Ç–µ—Ä–º–æ–ø–∞—Å—Ç–∞', '–ö–∏—à–µ–Ω—ñ –¥–ª—è –∂–æ—Å—Ç–∫–∏—Ö –¥–∏—Å–∫—ñ–≤'
            ],
            '–ú–µ—Ä–µ–∂–µ–≤–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è': [
                '–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–∏', '–ö–æ–º—É—Ç–∞—Ç–æ—Ä–∏', '–¢–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø—É', '–ü–∞—Ç—á –ø–∞–Ω–µ–ª—ñ',
                '–ü–∞—Ç—á-–∫–æ—Ä–¥—ñ', '–ö–∞–±–µ–ª—å –¥–ª—è —Å–∏—Å—Ç–µ–º –∑–≤\'—è–∑–∫—É', '–ú–µ—Ä–µ–∂–µ–≤—ñ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∏, –º–æ–¥—É–ª—ñ —ñ —Ä–æ–∑\'—î–º–∏',
                '–û–ø—Ç–∏—á–Ω—ñ –∫–æ–Ω–≤–µ—Ä—Ç–æ—Ä–∏', '–ú–æ–¥—É–ª—ñ GBIC —Ç–∞ SFP', '–ú–æ–Ω—Ç–∞–∂–Ω—ñ —à–∞—Ñ–∏',
                '–®–∞—Ñ–∏ –º–æ–Ω—Ç–∞–∂–Ω—ñ', 'IP-, skype- —Ç–µ–ª–µ—Ñ–æ–Ω–∏', '–ö–∞–º–µ—Ä–∏ –≤—ñ–¥–µ–æ—Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è'
            ],
            '–ö–∞–±–µ–ª—ñ, –ø–æ–¥–æ–≤–∂—É–≤–∞—á—ñ': [
                '–ö–∞–±–µ–ª—ñ –¥–ª—è –µ–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∏', '–ü–æ–¥–æ–≤–∂—É–≤–∞—á—ñ –µ–ª–µ–∫—Ç—Ä–∏—á–Ω—ñ', 'USB –∫–∞–±–µ–ª—ñ',
                'HDMI –∫–∞–±–µ–ª—ñ', '–ê—É–¥—ñ–æ –∫–∞–±–µ–ª—ñ', '–ö–∞–±–µ–ª—å –∂–∏–≤–ª–µ–Ω–Ω—è', '–ï–ª–µ–∫—Ç—Ä–æ—ñ–∑–æ–ª—è—Ü—ñ–π–Ω—ñ —Å—Ç—Ä—ñ—á–∫–∏'
            ],
            '–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏, –∞–¥–∞–ø—Ç–µ—Ä–∏': [
                '–ê–¥–∞–ø—Ç–µ—Ä–∏ –∏ –ø–ª–∞—Ç–∏ —Ä–∞–∑—à–∏—Ä–µ–Ω–Ω—è', '–ê–≤—Ç–æ–º–æ–±—ñ–ª—å–Ω—ñ –∞–¥–∞–ø—Ç–µ—Ä–∏ –∂–∏–≤–ª–µ–Ω–Ω—è',
                '–ü—ñ–¥—Å—Ç–∞–≤–∫–∏ —Ç—Ä–∏–º–∞—á—ñ –¥–ª—è –ø–æ—Ä—Ç–∞—Ç–∏–≤–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤', '–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ –¥–ª—è —Ä–æ–∑–µ—Ç–æ–∫'
            ],
            '–î–ª—è –æ—Ñ—ñ—Å—É, –¢–í, —ñ–Ω—à–µ': [
                '–¢–µ–ª–µ–≤—ñ–∑–æ—Ä–∏', '–ü—Ä–æ–µ–∫—Ç–æ—Ä–∏', '–ü—Ä–æ–µ–∫—Ü—ñ–π–Ω—ñ –µ–∫—Ä–∞–Ω–∏', '–°—Ç–∞—Ü—ñ–æ–Ω–∞—Ä–Ω—ñ —Ç–µ–ª–µ—Ñ–æ–Ω–∏',
                '–†–∞–¥—ñ–æ–Ω—è–Ω—ñ, –≤—ñ–¥–µ–æ–Ω—è–Ω—ñ', '–õ–∞–º—ñ–Ω–∞—Ç–æ—Ä–∏', '–ü–ª—ñ–≤–∫–∏ –¥–ª—è –ª–∞–º—ñ–Ω—É–≤–∞–Ω–Ω—è',
                '–ë—ñ–Ω–¥–µ—Ä –¥–ª—è –∑—à–∏–≤–∞–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤', '–°–∫–∞–Ω–µ—Ä–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥—ñ–≤',
                '–ü—Ä–∏–Ω—Ç–µ—Ä—ã –µ—Ç–∏–∫–µ—Ç–æ–∫, —à—Ç—Ä–∏—Ö–∫–æ–¥—ñ–≤, —á–µ–∫—ñ–≤', '–û—Ñ—ñ—Å–Ω–∏–π —ñ –ø–æ–ª—ñ–≥—Ä–∞—Ñ—ñ—á–Ω–∏–π –ø–∞–ø—ñ—Ä',
                '–§–∞–π–ª–∏ —ñ –ø–∞–ø–∫–∏', '–ö–∞–Ω—Ü–µ–ª—è—Ä—Å—å–∫–∏–π —ñ –ø–∞–∫—É–≤–∞–ª—å–Ω–∏–π —Å–∫–æ—Ç—á'
            ],
            '–í–∏—Ç—Ä–∞—Ç–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏': [
                '–¢–æ–Ω–µ—Ä —ñ —á–æ—Ä–Ω–∏–ª–∞ –¥–ª—è –¥—Ä—É–∫—É', '–ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä—ñ–≤ —Ç–∞ –ë–§–ü',
                '–§–æ—Ç–æ–±–∞—Ä–∞–±–∞–Ω–∏', '–§–æ—Ç–æ–ø–∞–ø—ñ—Ä', '–í–∏—Ç—Ä–∞—Ç–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –¥–ª—è 3D –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤',
                '–°—Ç—Ä—ñ—á–∫–∏ LED'
            ],
            '–†–µ–º–æ–Ω—Ç –∫–∞—Ä—Ç—Ä–∏–¥–∂—ñ–≤': [
                '–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ —ñ –∫–æ–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–æ –æ—Ñ—ñ—Å–Ω–æ—ó —Ç–µ—Ö–Ω—ñ–∫–∏', '–§–æ—Ç–æ–±–∞—Ä–∞–±–∞–Ω–∏',
                '–ß–∏–ø–æ–≤–∞–Ω—ñ –∫–∞—Ä—Ç—Ä–∏–¥–∂—ñ', '–†–µ–º–æ–Ω—Ç–Ω—ñ –∫–æ–º–ø–ª–µ–∫—Ç–∏'
            ],
            '–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏': [
                '–ê–≤—Ç–æ-, –º–æ—Ç–æ', '–ê–∫—Å–µ—Å—É–∞—Ä—ñ –¥–ª—è –∞–≤—Ç–æ', '–ê–≤—Ç–æ–º–æ–±—ñ–ª—å–Ω—ñ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∞–∫—Å–µ—Å—É–∞—Ä–∏',
                '–í—ñ–¥–µ–æ—Ä–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –∞–≤—Ç–æ–º–æ–±—ñ–ª—å–Ω—ñ', 'GPS-–Ω–∞–≤—ñ–≥–∞—Ç–æ—Ä–∏', '–ê–≤—Ç–æ–º–æ–±—ñ–ª—å–Ω—ñ —ñ–Ω–≤–µ—Ä—Ç–æ—Ä–∏',
                '–ê–≤—Ç–æ–º–æ–±—ñ–ª—å–Ω—ñ –ø—É—Å–∫–æ-–∑–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó', '–ê–≤—Ç–æ—Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏',
                '–ê–≤—Ç–æ–º–æ–±—ñ–ª—å–Ω—ñ —â—ñ—Ç–∫–∏ —Ç–∞ —Å–∫—Ä–µ–±–∫–∏'
            ],
            '–î–æ–≥–ª—è–¥ –∑–∞ —Ç–µ—Ö–Ω—ñ–∫–æ—é': [
                '–ó–∞—Å–æ–±–∏ –¥–ª—è —á–∏—Å—Ç–∫–∏ —Ü–∏—Ñ—Ä–æ–≤–æ—ó —Ç–µ—Ö–Ω—ñ–∫–∏', '–ß–∏—Å—Ç—è—á—ñ –∑–∞—Å–æ–±–∏ –¥–ª—è —Ü–∏—Ñ—Ä–æ–≤–æ—ó —Ç–µ—Ö–Ω—ñ–∫–∏',
                '–ï—Ç–∏–∫–µ—Ç–∫–∏ —Ç–∞ –±–∏—Ä–∫–∏', '–ó–∞–º–∫–∏ –¥–ª—è –Ω–æ—É—Ç–±—É–∫—ñ–≤'
            ],
            '–ü–æ–±—É—Ç–æ–≤–∞ —Ç–µ—Ö–Ω—ñ–∫–∞': [
                '–ü–æ–±—É—Ç–æ–≤–∞ —Ç–µ—Ö–Ω—ñ–∫–∞', '–ö–ª—ñ–º–∞—Ç–∏—á–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞', '–Ü–Ω—Ñ—Ä–∞—á–µ—Ä–≤–æ–Ω—ñ —ñ –∫–∞—Ç–∞–ª—ñ—Ç–∏—á–Ω—ñ –æ–±—ñ–≥—Ä—ñ–≤–∞—á—ñ',
                '–ü–æ–±—É—Ç–æ–≤—ñ –º–∞—Å–ª—è–Ω—ñ –æ–±—ñ–≥—Ä—ñ–≤–∞—á—ñ', '–ö–æ–Ω–≤–µ–∫—Ç–æ—Ä–∏', '–ú—ñ–∫—Ä–æ—Ö–≤–∏–ª—å–æ–≤—ñ –ø–µ—á—ñ',
                '–ü—Ä–∞—Å–∫–∏', '–§–µ–Ω—ã –¥–ª—è –≤–æ–ª–æ—Å—Å—è', '–ë–ª–µ–Ω–¥–µ—Ä–∏', '–ï–ª–µ–∫—Ç—Ä–æ—á–∞–π–Ω–∏–∫–∏',
                '–ö–∞–≤–æ–≤–∞—Ä–∫–∏/–ö–∞–≤–æ–º–∞—à–∏–Ω–∏', '–ö–∞–≤–æ–º–æ–ª–∫–∏', '–ï–ª–µ–∫—Ç—Ä–∏—á–Ω—ñ –º\'—è—Å–æ—Ä—É–±–∫–∏',
                '–ú—ñ–∫—Å–µ—Ä–∏', '–ú—É–ª—å—Ç–∏–≤–∞—Ä–∫–∏', '–ü–ª–∏—Ç–∏ –Ω–∞—Å—Ç—ñ–ª—å–Ω—ñ', '–ö—É—Ö–æ–Ω–Ω—ñ –∫–æ–º–±–∞–π–Ω–∏/–º–∞—à–∏–Ω–∏/–ø–æ–¥—Ä—ñ–±–Ω—é–≤–∞—á—ñ',
                '–°–æ–∫–æ–≤–∏—Ç–∏—Å–∫–∞—á—ñ', '–°—É—à–∞—Ä–∫–∏/–î–µ–≥—ñ–¥—Ä–∞—Ç–æ—Ä–∏', '–¢–æ—Å—Ç–µ—Ä—ñ', '–†–æ–±–æ—Ç–∏-–ø–∏–ª–æ—Å–æ—Å–∏',
                '–ü—Ä–∞—Å—É–≤–∞–ª—å–Ω—ñ –¥–æ—à–∫–∏', '–ö—É—Ö–æ–Ω–Ω—ñ –Ω–æ–∂—ñ —ñ –ø—ñ–¥—Å—Ç–∞–≤–∫–∏', '–í–∞–≥–∏ –∫—É—Ö–æ–Ω–Ω—ñ',
                '–í–∞–≥–∏ –ø—ñ–¥–ª–æ–≥–æ–≤—ñ', '–ï–ª–µ–∫—Ç—Ä–∏—á–Ω—ñ –≥—Ä—ñ–ª–∫–∏', '–ó–≤–æ–ª–æ–∂—É–≤–∞—á—ñ —Ç–∞ –æ—á–∏—â—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è',
                '–û—Ö–æ—Ä–æ–Ω–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ —Å–∏–≥–Ω–∞–ª—ñ–∑–∞—Ü—ñ—ó'
            ]
        };

        // –§–æ—Ä–º—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É –≤—Å—ñ—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
        const allCategories = {};
        for (const [mainCat, subCats] of Object.entries(mainCategories)) {
            allCategories[mainCat] = subCats;
        }

        // –û–±—Ä–æ–±–∫–∞ —Ç–æ–≤–∞—Ä—ñ–≤
        cachedProducts = result.yml_catalog.shop[0].offers[0].offer.map(item => {
            const xmlCategory = categoriesMap[item.categoryId[0]] || '–Ü–Ω—à–µ';

            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –¥–æ —è–∫–æ—ó –æ—Å–Ω–æ–≤–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –Ω–∞–ª–µ–∂–∏—Ç—å —Ç–æ–≤–∞—Ä
            let mainCategory = '–Ü–Ω—à–µ';
            let subCategory = xmlCategory;

            for (const [mainCat, subCats] of Object.entries(mainCategories)) {
                if (subCats.includes(xmlCategory)) {
                    mainCategory = mainCat;
                    break;
                }
            }

            return {
                id: item.$.id,
                name: item.name[0],
                price: parseFloat(item.price[0]).toFixed(2),
                image: item.picture?.[0] || '/images/no-image.jpg',
                category: mainCategory,
                subCategory: subCategory,
                description: item.description?.[0] || '',
                available: item.$.available === 'true'
            };
        });

        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
        cachedCategories = Object.keys(mainCategories);
        cachedSubCategories = mainCategories;

        lastUpdate = Date.now();

        saveBackup();
        console.log(`–û–Ω–æ–≤–ª–µ–Ω–æ: ${cachedProducts.length} —Ç–æ–≤–∞—Ä—ñ–≤, ${cachedCategories.length} –æ—Å–Ω–æ–≤–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π`);
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö:', error);
        throw error;
    }
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑–µ—Ä–≤—É
async function saveBackup() {
    const backupData = {
        products: cachedProducts,
        categories: cachedCategories,
        subCategories: cachedSubCategories,
        timestamp: lastUpdate
    };

    await fs.writeFile(
        path.join(__dirname, 'data', 'last-products.json'),
        JSON.stringify(backupData, null, 2),
        'utf-8'
    );
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
async function loadProducts() {
    try {
        console.log(`–°–ø—Ä–æ–±—É—é –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ XML –∑ ${XML_URL}...`);
        const response = await axios.get(XML_URL, {
            timeout: 10000,
            headers: { 'User-Agent': 'MyShop/1.0' }
        });
        const result = await xml2js.parseStringPromise(response.data);
        processData(result);
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è XML:', error.message);
        await loadLocalBackup();
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∑–µ—Ä–≤—É
async function loadLocalBackup() {
    try {
        const backupPath = path.join(__dirname, 'data', 'last-products.json');

        if (!existsSync(backupPath)) {
            console.log('–†–µ–∑–µ—Ä–≤–Ω–∏–π —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, —Å–ø—Ä–æ–±—É—é –ª–æ–∫–∞–ª—å–Ω–∏–π XML...');
            await loadLocalXML();
            return;
        }

        const data = await fs.readFile(backupPath, 'utf-8');
        const backup = JSON.parse(data);

        cachedProducts = backup.products || [];
        cachedCategories = backup.categories || [];
        cachedSubCategories = backup.subCategories || {};
        lastUpdate = backup.timestamp || Date.now();

        console.log(`–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –¥–∞–Ω—ñ (${cachedProducts.length} —Ç–æ–≤–∞—Ä—ñ–≤, ${cachedCategories.length} –∫–∞—Ç–µ–≥–æ—Ä—ñ–π)`);
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ —Ä–µ–∑–µ—Ä–≤—É:', e.message);
        await loadLocalXML();
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ XML
async function loadLocalXML() {
    try {
        const xmlPath = path.join(__dirname, 'data', 'products.xml');
        if (!existsSync(xmlPath)) {
            throw new Error('–õ–æ–∫–∞–ª—å–Ω–∏–π XML —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        }

        const data = await fs.readFile(xmlPath, 'utf-8');
        const result = await xml2js.parseStringPromise(data);
        processData(result);
        console.log('–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –ª–æ–∫–∞–ª—å–Ω–∏–π XML —Ñ–∞–π–ª');
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ XML:', error.message);
        await createEmptyBackup();
    }
}

// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—å–æ–≥–æ —Ä–µ–∑–µ—Ä–≤—É
async function createEmptyBackup() {
    cachedProducts = [];
    cachedCategories = [];
    cachedSubCategories = {};
    lastUpdate = Date.now();

    await saveBackup();
    console.log('–°—Ç–≤–æ—Ä–µ–Ω–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä–µ–∑–µ—Ä–≤–Ω–∏–π —Ñ–∞–π–ª');
}

// API
app.get('/api/products', async (req, res) => {
    try {
        const { category } = req.query;
        let filteredProducts = cachedProducts.filter(p => p.available);

        if (category) {
            filteredProducts = filteredProducts.filter(p => p.category === category);
        }

        res.json({
            success: true,
            products: filteredProducts,
            lastUpdate: new Date(lastUpdate).toISOString(),
            count: filteredProducts.length
        });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

app.get('/api/categories', async (req, res) => {
    res.json({
        success: true,
        categories: cachedCategories,
        subCategories: cachedSubCategories
    });
});

// –°—Ç–æ—Ä—ñ–Ω–∫–∏
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

app.get('/cart', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'cart.html'));
});

app.get('/category/:categoryName', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
async function startServer() {
    await loadProducts();

    // –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ –æ–Ω–æ–≤–ª–µ–Ω—å (–∫–æ–∂–Ω—ñ 30 —Ö–≤)
    cron.schedule('*/30 * * * *', () => {
        console.log('\n--- –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è ---');
        loadProducts();
    });

    app.listen(PORT, () => {
        console.log(`
            üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ: http://localhost:${PORT}
            ‚è± –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ${new Date(lastUpdate).toLocaleString()}
            üì¶ –¢–æ–≤–∞—Ä—ñ–≤: ${cachedProducts.length}
            üóÇ –û—Å–Ω–æ–≤–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π: ${cachedCategories.length}
        `);
    });
}

startServer().catch(error => {
    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞:', error);
    process.exit(1);
});